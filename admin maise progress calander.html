<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin â€¢ Chores</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1020">
<style>
  :root{
    --bg:#0b1020; --text:#e8ecff; --muted:#a9b4e6; --line:rgba(255,255,255,.12);
    --shadow:0 18px 50px rgba(0,0,0,.45); --radius:18px;
    --hi:#60a5fa; --ok:#36d399; --bad:#fb7185; --warn:#fbbf24;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
      radial-gradient(900px 500px at 90% 0%, rgba(251,113,133,.18), transparent 60%),
      radial-gradient(1000px 700px at 60% 120%, rgba(54,211,153,.14), transparent 60%),
      var(--bg);
    padding:18px;
  }
  .wrap{max-width:1180px;margin:0 auto}
  .card{
    border:1px solid var(--line);
    border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .top{
    padding:16px 18px;
    border-bottom:1px solid var(--line);
    background:rgba(0,0,0,.12);
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }
  h1{margin:0;font-size:18px;letter-spacing:.3px}
  .sub{color:var(--muted);font-size:12.5px;margin-top:6px;line-height:1.35}
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    padding:9px 11px;
    border-radius:12px;
    cursor:pointer;
    font:inherit;
  }
  .btn:hover{background:rgba(255,255,255,.09)}
  .btn.primary{border-color:rgba(96,165,250,.50);background:rgba(96,165,250,.16)}
  .btn.ok{border-color:rgba(54,211,153,.45);background:rgba(54,211,153,.12)}
  .btn.bad{border-color:rgba(251,113,133,.45);background:rgba(251,113,133,.12)}
  .btn.icon{padding:7px 9px;border-radius:10px}
  select, input{
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    color:var(--text);
    padding:9px 10px;
    border-radius:12px;
    font:inherit;
  }
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
    padding:10px 18px;
    border-bottom:1px solid var(--line);
    background:rgba(0,0,0,.10);
  }
  .tab{
    border:1px solid var(--line);
    background:rgba(0,0,0,.14);
    padding:9px 12px;
    border-radius:999px;
    cursor:pointer;
    font-size:13px;
    color:var(--text);
  }
  .tab.active{border-color:rgba(96,165,250,.50);background:rgba(96,165,250,.14)}
  .pane{display:none;padding:16px 18px}
  .pane.active{display:block}
  .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:14px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .panel{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(0,0,0,.14);
    padding:14px;
  }
  .panel h2{margin:0 0 10px;font-size:14px;letter-spacing:.2px}
  .muted{color:var(--muted);font-size:12.5px}
  table{width:100%;border-collapse:collapse}
  th,td{text-align:left;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);font-size:13px;vertical-align:top}
  th{color:rgba(169,180,230,.85);font-weight:600;font-size:12px}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.18);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.ok{background:var(--ok)}
  .dot.bad{background:var(--bad)}
  .dot.warn{background:var(--warn)}
  .calendarHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .calTitle{font-size:14px;font-weight:700}
  .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .dow{color:rgba(169,180,230,.85);font-size:11px;padding:2px 4px}
  .day{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.16);
    border-radius:14px;
    padding:10px 10px 9px;
    min-height:74px;
    cursor:pointer;
  }
  .day:hover{background:rgba(0,0,0,.22)}
  .day.off{opacity:.45}
  .dayNum{font-size:12.5px;color:rgba(232,236,255,.92);display:flex;justify-content:space-between;align-items:center}
  .countRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .badge{font-size:11px;padding:3px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--muted)}
  .badge.ok{border-color:rgba(54,211,153,.35);color:#d8fff0}
  .badge.bad{border-color:rgba(251,113,133,.35);color:#ffd7df}
  .gallery{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:1100px){.gallery{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:820px){.gallery{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:520px){.gallery{grid-template-columns:1fr}}
  .gItem{border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.16);border-radius:16px;overflow:hidden}
  .gItem img{width:100%;height:160px;object-fit:cover;display:block;background:rgba(0,0,0,.2)}
  .gMeta{padding:10px}
  .gName{font-size:13px;font-weight:700;margin:0 0 6px}
  .gSub{font-size:12px;color:var(--muted);margin:0}
  .msg{margin-top:10px;font-size:12.5px;color:var(--muted)}
  a{color:var(--hi)}
  code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; font-size:11px}

  /* Modal */
  .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
  .modalBackdrop.show{display:flex}
  .modal{width:min(720px, 100%);border:1px solid var(--line);border-radius:20px;background:linear-gradient(180deg, rgba(10,16,32,.92), rgba(10,16,32,.80));box-shadow:var(--shadow);overflow:hidden}
  .modalHeader{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .modalTitle{font-weight:800}
  .modalBody{padding:14px 16px}
  .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.formGrid{grid-template-columns:1fr}}
  .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .field input,.field select{width:100%}
  .modalFooter{padding:14px 16px;border-top:1px solid rgba(255,255,255,.10);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
  .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
  .toast{position:fixed;left:18px;right:18px;bottom:18px;display:none;z-index:10000}
  .toast.show{display:block}
  .toastInner{max-width:1180px;margin:0 auto;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border-radius:16px;padding:10px 12px;color:var(--text)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div>
        <h1>Admin â€¢ Chores</h1>
        <div class="sub">Add / edit / delete chores. Calendar + proof gallery. Auto-refresh every 5 seconds.</div>
      </div>
      <div class="actions">
        <span class="pill">Admin: <strong style="color:var(--text)">kimwilson521@gmail.com</strong></span>
        <button class="btn primary" id="addBtn">+ Add chore</button>
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn bad" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="calendar">Calendar</button>
      <button class="tab" data-tab="proof">Proof</button>
    </div>

    <div class="pane active" id="tab-dashboard">
      <div class="grid">
        <div class="panel">
          <h2>Chores</h2>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
            <label class="muted" style="display:flex;gap:8px;align-items:center;margin:0">
              Assignee
              <select id="assigneeSel"></select>
            </label>
            <label class="muted" style="display:flex;gap:8px;align-items:center;margin:0">
              View
              <select id="viewSel">
                <option value="all" selected>All</option>
                <option value="open">Open</option>
                <option value="done">Done</option>
              </select>
            </label>
            <span class="muted" id="summary"></span>
          </div>
          <div style="overflow:auto">
            <table id="table">
              <thead>
                <tr>
                  <th>Chore</th><th>Assignee</th><th>Due</th><th>Priority</th><th>Location</th><th>Frequency</th><th>Status</th><th>Proof</th><th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="msg" id="dashMsg"></div>
        </div>

        <div class="panel">
          <h2>Quick stats</h2>
          <div class="muted" id="statsBox">Loadingâ€¦</div>
          <hr style="border:none;border-top:1px solid rgba(255,255,255,.10);margin:12px 0">
          <div class="muted">
            Backend: <code id="backendUrl"></code>
          </div>
          <div class="hint">
            <b>Location column:</b> add a new header called <code>location</code> in your CHORES sheet (recommended).
            If you don't add it, location will be stored in <code>category</code> as a fallback.
          </div>
        </div>
      </div>
    </div>

    <div class="pane" id="tab-calendar">
      <div class="grid">
        <div class="panel">
          <div class="calendarHead">
            <div class="calTitle" id="calTitle">Calendar</div>
            <div class="actions">
              <button class="btn" id="prevMonth">â—€</button>
              <button class="btn" id="todayBtn">Today</button>
              <button class="btn" id="nextMonth">â–¶</button>
            </div>
          </div>

          <div class="calGrid" id="dowRow"></div>
          <div class="calGrid" id="calGrid"></div>

          <div class="msg" id="calMsg"></div>
        </div>

        <div class="panel">
          <h2 id="dayTitle">Day details</h2>
          <div class="muted" id="dayHint">Tap a day to see chores + proof.</div>
          <div id="dayList" style="margin-top:10px;display:flex;flex-direction:column;gap:10px"></div>
        </div>
      </div>
    </div>

    <div class="pane" id="tab-proof">
      <div class="panel">
        <h2>Proof gallery</h2>
        <div class="muted" style="margin-bottom:10px">Shows photos from completed chores (Drive links).</div>
        <div class="gallery" id="gallery"></div>
        <div class="msg" id="proofMsg"></div>
      </div>
    </div>

  </div>
</div>

<!-- Modal: Add/Edit -->
<div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div class="modalTitle" id="modalTitle">Add chore</div>
      <button class="btn icon" id="closeModalBtn">âœ•</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>Chore name</label>
          <input id="fName" placeholder="e.g. Cat litter">
        </div>
        <div class="field">
          <label>Assignee</label>
          <select id="fAssignee"></select>
        </div>

        <div class="field">
          <label>Due date</label>
          <input id="fDue" type="date">
        </div>
        <div class="field">
          <label>Priority</label>
          <select id="fPriority">
            <option value="low">low</option>
            <option value="medium" selected>medium</option>
            <option value="high">high</option>
          </select>
        </div>

        <div class="field">
          <label>Location</label>
          <input id="fLocation" placeholder="e.g. Kitchen">
        </div>
        <div class="field">
          <label>Frequency</label>
          <select id="fRepeat">
            <option value="none" selected>none</option>
            <option value="daily">daily</option>
            <option value="weekly">weekly</option>
            <option value="monthly">monthly</option>
            <option value="everyX">every X days</option>
          </select>
        </div>

        <div class="field" id="everyXWrap" style="display:none">
          <label>Every X days</label>
          <input id="fEveryX" type="number" min="2" max="365" value="3">
        </div>
        <div class="field">
          <label>Category (optional)</label>
          <input id="fCategory" placeholder="optional">
        </div>
      </div>

      <div class="hint" id="modalHint">
        This writes to Google Sheets via Apps Script. Save triggers a refresh.
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" id="cancelBtn">Cancel</button>
      <button class="btn ok" id="saveBtn">Save</button>
      <button class="btn bad" id="deleteBtn" style="display:none">Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="toastInner" id="toastInner">Saved</div></div>

<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx_H3KG5QXjuvU9SDWWLIq0H70h6bxIF_6guW5Rd7lOUOa9DFOeaHtJhOSDbw9lXa6T/exec";
  document.getElementById('backendUrl').textContent = WEBAPP_URL;

  // Admin lock (client-side). If missing token, send to login.
  const token = sessionStorage.getItem('admin_token');
  if(!token) {
    location.href = "index.html";
  }

  // ---- JSONP helper (GET) ----
  function jsonp(params) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      params.callback = cb;
      const qs = new URLSearchParams(params).toString();

      const s = document.createElement('script');
      s.src = WEBAPP_URL + "?" + qs;

      let done = false;
      window[cb] = (data) => {
        done = true;
        cleanup();
        resolve(data);
      };

      function cleanup(){
        try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      s.onerror = () => {
        if(done) return;
        cleanup();
        reject(new Error("JSONP load failed"));
      };

      document.body.appendChild(s);
      setTimeout(() => {
        if(done) return;
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 12000);
    });
  }

  // ---- POST helper (WRITE). Use no-cors so browser doesn't block; then refresh. ----
  async function postNoCors(action, payload) {
    const p = new URLSearchParams({ action });
    Object.entries(payload || {}).forEach(([k,v]) => {
      if(v !== undefined && v !== null) p.set(k, String(v));
    });

    // We cannot read the response due to CORS, but request is sent.
    await fetch(WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      body: p
    });
  }

  // ---- Date helpers ----
  function toYMD(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const y = dt.getUTCFullYear();
    const m = String(dt.getUTCMonth()+1).padStart(2,'0');
    const day = String(dt.getUTCDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function niceDate(iso){
    if(!iso) return "";
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
  }
  function niceTime(iso){
    if(!iso) return "";
    const d = new Date(iso);
    return d.toLocaleString();
  }

  // ---- State ----
  let chores = [];
  let monthOffset = 0;
  let selectedDayYMD = null;

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[m]);
  }

  function toast(msg){
    const t = document.getElementById('toast');
    document.getElementById('toastInner').textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2500);
  }

  async function loadAll(){
    try {
      const out = await jsonp({ action:"listChores" });
      if(!out.ok) throw new Error(out.error || "Load failed");
      chores = out.items || [];
      buildAssignees();
      syncAssigneeOptionsInForm();
      renderDashboard();
      renderCalendar();
      renderProof();
      document.getElementById('dashMsg').textContent = "";
      document.getElementById('calMsg').textContent = "";
      document.getElementById('proofMsg').textContent = "";
    } catch (e) {
      document.getElementById('dashMsg').textContent = "Load error: " + e.message;
      document.getElementById('calMsg').textContent = "Load error: " + e.message;
      document.getElementById('proofMsg').textContent = "Load error: " + e.message;
    }
  }

  function uniq(arr){ return Array.from(new Set(arr)); }

  function buildAssignees(){
    const sel = document.getElementById('assigneeSel');
    const current = sel.value || "All";
    const names = uniq(chores.map(c => String(c.assignee||"").trim()).filter(Boolean)).sort();
    sel.innerHTML = "";
    sel.appendChild(new Option("All", "All"));
    names.forEach(n => sel.appendChild(new Option(n, n)));
    sel.value = names.includes(current) ? current : "All";
  }

  function syncAssigneeOptionsInForm(){
    const names = uniq(chores.map(c => String(c.assignee||"").trim()).filter(Boolean)).sort();
    const sel = document.getElementById('fAssignee');
    const current = sel.value || (names[0] || "Maisie");
    sel.innerHTML = "";
    (names.length ? names : ["Maisie"]).forEach(n => sel.appendChild(new Option(n, n)));
    sel.value = current;
  }

  function getLocation(c){
    // Preferred: location column; fallback: category
    return (c.location && String(c.location).trim()) ? String(c.location) : (c.category ? String(c.category) : "");
  }

  function filteredChores(){
    const who = document.getElementById('assigneeSel').value;
    const view = document.getElementById('viewSel').value;
    return chores.filter(c => {
      if(who !== "All" && String(c.assignee) !== who) return false;
      const done = String(c.done).toLowerCase() === "true" || c.done === true;
      if(view === "open" && done) return false;
      if(view === "done" && !done) return false;
      return true;
    });
  }

  function formatRepeat(c){
    if(!c.repeat) return "none";
    if(String(c.repeat)==="everyX") return `every ${c.repeatEveryDays||""} days`;
    return String(c.repeat);
  }

  function renderDashboard(){
    const list = filteredChores();
    const tb = document.querySelector("#table tbody");
    tb.innerHTML = "";

    const open = list.filter(c => !(String(c.done).toLowerCase()==="true" || c.done===true)).length;
    const done = list.length - open;

    document.getElementById('summary').textContent = `Showing ${list.length} chores â€¢ Open ${open} â€¢ Done ${done}`;

    list
      .sort((a,b) => toYMD(a.due).localeCompare(toYMD(b.due)))
      .forEach(c => {
        const tr = document.createElement('tr');

        const doneFlag = (String(c.done).toLowerCase()==="true" || c.done===true);
        const status = doneFlag ? "Done" : "Open";
        const due = c.due ? niceDate(c.due) : "";
        const rep = formatRepeat(c);
        const loc = getLocation(c);
        const pr = c.priority ? String(c.priority) : "medium";

        tr.innerHTML = `
          <td>${escapeHtml(c.name||"")}</td>
          <td>${escapeHtml(c.assignee||"")}</td>
          <td>${escapeHtml(due)}</td>
          <td>${escapeHtml(pr)}</td>
          <td>${escapeHtml(loc)}</td>
          <td>${escapeHtml(rep)}</td>
          <td><span class="pill"><span class="dot ${doneFlag?'ok':'warn'}"></span>${status}</span></td>
          <td>${c.photoUrl ? `<a href="${c.photoUrl}" target="_blank" rel="noopener">Open</a>` : ""}</td>
          <td style="white-space:nowrap">
            <button class="btn icon" title="Edit" data-edit="${escapeHtml(c.id)}">âœŽ</button>
            <button class="btn icon bad" title="Delete" data-del="${escapeHtml(c.id)}">ðŸ—‘</button>
          </td>
        `;
        tb.appendChild(tr);
      });

    // Hook action buttons
    tb.querySelectorAll("[data-edit]").forEach(b => {
      b.addEventListener("click", () => openEditModal(String(b.getAttribute("data-edit"))));
    });
    tb.querySelectorAll("[data-del]").forEach(b => {
      b.addEventListener("click", () => confirmDelete(String(b.getAttribute("data-del"))));
    });

    // stats
    const totalAll = chores.length;
    const doneAll = chores.filter(c => (String(c.done).toLowerCase()==="true" || c.done===true)).length;
    const withProof = chores.filter(c => c.photoUrl).length;
    const repeatDaily = chores.filter(c => String(c.repeat)==="daily").length;
    const repeatWeekly = chores.filter(c => String(c.repeat)==="weekly").length;

    document.getElementById('statsBox').innerHTML = `
      <div class="countRow">
        <span class="badge">Total: <b>${totalAll}</b></span>
        <span class="badge ok">Done: <b>${doneAll}</b></span>
        <span class="badge">Proof photos: <b>${withProof}</b></span>
      </div>
      <div class="muted" style="margin-top:8px">
        Daily: ${repeatDaily} â€¢ Weekly: ${repeatWeekly}
      </div>
    `;
  }

  function renderCalendar(){
    const now = new Date();
    const base = new Date(now.getFullYear(), now.getMonth()+monthOffset, 1);
    const year = base.getFullYear();
    const month = base.getMonth();

    const monthName = base.toLocaleDateString(undefined, { month:'long', year:'numeric' });
    document.getElementById('calTitle').textContent = monthName;

    // DOW
    const dows = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const dowRow = document.getElementById('dowRow');
    dowRow.innerHTML = "";
    dows.forEach(d => {
      const el = document.createElement('div');
      el.className = "dow";
      el.textContent = d;
      dowRow.appendChild(el);
    });

    // Build map counts by day
    const map = {};
    chores.forEach(c => {
      if(!c.due) return;
      const ymd = toYMD(c.due);
      if(!map[ymd]) map[ymd] = { total:0, done:0, items:[] };
      map[ymd].total++;
      const doneFlag = (String(c.done).toLowerCase()==="true" || c.done===true);
      if(doneFlag) map[ymd].done++;
      map[ymd].items.push(c);
    });

    const first = new Date(Date.UTC(year, month, 1));
    let startOffset = (first.getUTCDay()+6)%7; // Monday-start
    const daysInMonth = new Date(Date.UTC(year, month+1, 0)).getUTCDate();

    const grid = document.getElementById('calGrid');
    grid.innerHTML = "";

    for(let cell=0; cell<42; cell++) {
      const dayNum = cell - startOffset + 1;
      const inMonth = dayNum >= 1 && dayNum <= daysInMonth;

      let dt = null;
      if(inMonth) {
        dt = new Date(Date.UTC(year, month, dayNum));
      } else {
        dt = new Date(Date.UTC(year, month, 1));
        dt.setUTCDate(dayNum);
      }
      const ymd = toYMD(dt);

      const box = document.createElement('div');
      box.className = "day" + (inMonth ? "" : " off");
      if(selectedDayYMD === ymd) {
        box.style.borderColor = "rgba(96,165,250,.60)";
        box.style.background = "rgba(96,165,250,.10)";
      }

      const counts = map[ymd] || { total:0, done:0, items:[] };
      const open = Math.max(0, counts.total - counts.done);

      box.innerHTML = `
        <div class="dayNum">
          <span>${dt.getUTCDate()}</span>
          <span class="pill" style="padding:2px 7px">${counts.total ? `${counts.done}/${counts.total}` : ""}</span>
        </div>
        <div class="countRow">
          ${counts.total ? `<span class="badge ok">Done ${counts.done}</span>` : ""}
          ${open ? `<span class="badge bad">Open ${open}</span>` : ""}
        </div>
      `;

      box.addEventListener('click', () => {
        selectedDayYMD = ymd;
        renderCalendar();
        renderDay(ymd, counts.items);
      });

      grid.appendChild(box);
    }

    if(selectedDayYMD && map[selectedDayYMD]) {
      renderDay(selectedDayYMD, map[selectedDayYMD].items);
    } else if(selectedDayYMD) {
      renderDay(selectedDayYMD, []);
    }
  }

  function renderDay(ymd, items){
    document.getElementById('dayTitle').textContent = "Day details â€¢ " + ymd;
    document.getElementById('dayHint').textContent = items.length ? `${items.length} chore(s) due.` : "No chores due for this day.";

    const list = document.getElementById('dayList');
    list.innerHTML = "";
    items
      .slice()
      .sort((a,b) => String(a.assignee).localeCompare(String(b.assignee)))
      .forEach(c => {
        const doneFlag = (String(c.done).toLowerCase()==="true" || c.done===true);
        const div = document.createElement('div');
        div.className = "panel";
        div.style.padding = "12px";
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div style="font-weight:800;font-size:13px">${escapeHtml(c.name||"")}</div>
              <div class="muted">${escapeHtml(c.assignee||"")} â€¢ Priority: ${escapeHtml(c.priority||"medium")} â€¢ Location: ${escapeHtml(getLocation(c)||"")}</div>
            </div>
            <div>
              <span class="pill"><span class="dot ${doneFlag?'ok':'bad'}"></span>${doneFlag?"Done":"Open"}</span>
            </div>
          </div>
          <div class="muted" style="margin-top:8px">
            ${doneFlag && c.doneAt ? `Done at: ${escapeHtml(niceTime(c.doneAt))}<br>` : ""}
            ${c.photoUrl ? `Proof: <a href="${c.photoUrl}" target="_blank" rel="noopener">Open photo</a>` : (doneFlag ? "<span style='color:#ffd7df'>No photo saved</span>" : "")}
          </div>
        `;
        list.appendChild(div);
      });
  }

  function renderProof(){
    const gal = document.getElementById('gallery');
    const items = chores
      .filter(c => c.photoUrl)
      .slice()
      .sort((a,b) => String(b.photoAt||b.doneAt||"").localeCompare(String(a.photoAt||a.doneAt||"")));

    gal.innerHTML = "";
    if(!items.length){
      document.getElementById('proofMsg').textContent = "No proof photos yet. Complete a chore with a photo and it will appear here.";
      return;
    }
    document.getElementById('proofMsg').textContent = "";

    items.forEach(c => {
      const div = document.createElement('div');
      div.className = "gItem";
      div.innerHTML = `
        <a href="${c.photoUrl}" target="_blank" rel="noopener">
          <img src="${c.photoUrl}" alt="Proof photo"/>
        </a>
        <div class="gMeta">
          <p class="gName">${escapeHtml(c.name||"")}</p>
          <p class="gSub">${escapeHtml(c.assignee||"")} â€¢ ${escapeHtml(niceTime(c.photoAt||c.doneAt||""))}</p>
        </div>
      `;
      gal.appendChild(div);
    });
  }

  // ---------- Add/Edit/Delete ----------
  let modalMode = "add"; // add|edit
  let editingId = null;

  const modal = document.getElementById('modalBackdrop');
  const everyXWrap = document.getElementById('everyXWrap');
  const fRepeat = document.getElementById('fRepeat');

  fRepeat.addEventListener('change', () => {
    everyXWrap.style.display = (fRepeat.value === "everyX") ? "block" : "none";
  });

  function openModal(){ modal.classList.add('show'); }
  function closeModal(){ modal.classList.remove('show'); editingId=null; modalMode="add"; }
  document.getElementById('closeModalBtn').addEventListener('click', closeModal);
  document.getElementById('cancelBtn').addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

  function setModalTitle(t){ document.getElementById('modalTitle').textContent = t; }

  function resetForm(){
    document.getElementById('fName').value = "";
    document.getElementById('fDue').value = "";
    document.getElementById('fPriority').value = "medium";
    document.getElementById('fLocation').value = "";
    document.getElementById('fRepeat').value = "none";
    document.getElementById('fEveryX').value = "3";
    document.getElementById('fCategory').value = "";
    everyXWrap.style.display = "none";
  }

  function openAddModal(){
    modalMode="add";
    editingId=null;
    setModalTitle("Add chore");
    resetForm();
    document.getElementById('deleteBtn').style.display = "none";
    document.getElementById('saveBtn').textContent = "Create";
    openModal();
  }

  function openEditModal(id){
    const c = chores.find(x => String(x.id) === String(id));
    if(!c) return toast("Chore not found");
    modalMode="edit";
    editingId = String(id);
    setModalTitle("Edit chore");
    document.getElementById('deleteBtn').style.display = "inline-flex";
    document.getElementById('saveBtn').textContent = "Save";
    document.getElementById('fName').value = c.name || "";
    document.getElementById('fAssignee').value = c.assignee || "Maisie";
    document.getElementById('fDue').value = c.due ? toYMD(c.due) : "";
    document.getElementById('fPriority').value = (c.priority || "medium");
    document.getElementById('fLocation').value = getLocation(c) || "";
    document.getElementById('fRepeat').value = (c.repeat || "none");
    document.getElementById('fEveryX').value = String(c.repeatEveryDays || 3);
    document.getElementById('fCategory').value = (c.category || "");
    everyXWrap.style.display = (document.getElementById('fRepeat').value === "everyX") ? "block" : "none";
    openModal();
  }

  async function confirmDelete(id){
    if(!confirm("Delete this chore?")) return;
    await doDelete(id);
  }

  async function doDelete(id){
    toast("Deletingâ€¦");
    await postNoCors("deleteChore", {
      id_token: token,
      choreId: id
    });
    closeModal();
    setTimeout(loadAll, 1200);
    toast("Deleted. Refreshingâ€¦");
  }

  document.getElementById('deleteBtn').addEventListener('click', async ()=>{
    if(!editingId) return;
    if(!confirm("Delete this chore?")) return;
    await doDelete(editingId);
  });

  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    const name = document.getElementById('fName').value.trim();
    const assignee = document.getElementById('fAssignee').value.trim();
    const due = document.getElementById('fDue').value; // YYYY-MM-DD
    const priority = document.getElementById('fPriority').value;
    const location = document.getElementById('fLocation').value.trim();
    const repeat = document.getElementById('fRepeat').value;
    const repeatEveryDays = (repeat === "everyX") ? document.getElementById('fEveryX').value : "";
    const category = document.getElementById('fCategory').value.trim();

    if(!name) return toast("Enter a chore name");
    if(!assignee) return toast("Select an assignee");

    toast(modalMode === "add" ? "Creatingâ€¦" : "Savingâ€¦");

    if(modalMode === "add"){
      await postNoCors("createChore", {
        id_token: token,
        name, assignee, due, priority,
        repeat, repeatEveryDays,
        // Send both: location + category. Script can choose where to store.
        location,
        category
      });
    } else {
      // Requires Apps Script action "updateChore" (see instructions below)
      await postNoCors("updateChore", {
        id_token: token,
        choreId: editingId,
        name, assignee, due, priority,
        repeat, repeatEveryDays,
        location,
        category
      });
    }

    closeModal();
    setTimeout(loadAll, 1200);
    toast("Saved. Refreshingâ€¦");
  });

  // Tabs
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.pane').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
  });

  // Controls
  document.getElementById('refreshBtn').addEventListener('click', loadAll);
  document.getElementById('assigneeSel').addEventListener('change', renderDashboard);
  document.getElementById('viewSel').addEventListener('change', renderDashboard);

  document.getElementById('prevMonth').addEventListener('click', ()=>{ monthOffset--; renderCalendar(); });
  document.getElementById('nextMonth').addEventListener('click', ()=>{ monthOffset++; renderCalendar(); });
  document.getElementById('todayBtn').addEventListener('click', ()=>{ monthOffset=0; selectedDayYMD=null; renderCalendar(); });

  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    sessionStorage.removeItem('admin_token');
    location.href = "index.html";
  });

  document.getElementById('addBtn').addEventListener('click', openAddModal);

  // Start
  loadAll();
  setInterval(loadAll, 5000);
</script>
</body>
</html>
