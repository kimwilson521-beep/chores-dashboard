<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Ä¢ Chores</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
body{font-family:system-ui;margin:0;background:#0b1020;color:#e8ecff}
header{padding:16px}
.small{color:#a9b4e6;font-size:13px}
.card{margin:16px;border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(255,255,255,.05);overflow:hidden}
.bar{display:flex;gap:10px;flex-wrap:wrap;padding:12px;border-bottom:1px solid rgba(255,255,255,.12)}
input,select,button{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#e8ecff}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;padding:12px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.item{padding:10px 12px;border-top:1px solid rgba(255,255,255,.12);display:flex;justify-content:space-between;gap:10px}
.meta{color:#a9b4e6;font-size:12px;margin-top:4px}
a{color:#e8ecff}
</style>
</head>
<body>
<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx_H3KG5QXjuvU9SDWWLIq0H70h6bxIF_6guW5Rd7lOUOa9DFOeaHtJhOSDbw9lXa6T/exec";
if(!sessionStorage.getItem("admin_token")) location.href="index.html";

function jsonp(action, params={}){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Date.now()+"_"+Math.floor(Math.random()*1e6);
    window[cb]=(data)=>{ try{resolve(data)} finally{ delete window[cb]; s.remove(); } };
    const qs=new URLSearchParams();
    qs.set("action", action);
    Object.entries(params).forEach(([k,v])=>{ if(v!==undefined&&v!==null) qs.set(k,String(v)); });
    qs.set("callback", cb);
    const s=document.createElement("script");
    s.src=WEBAPP_URL+"?"+qs.toString();
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error("JSONP failed")); };
    document.body.appendChild(s);
  });
}
</script>

<header>
  <h2 style="margin:0">Admin ‚Ä¢ Chores</h2>
  <div class="small">Fixes CORS by reading via JSONP (GET). Auto-refresh every 5 seconds.</div>
</header>

<div class="card">
  <div class="bar">
    <input id="q" placeholder="Search">
    <select id="ass"><option value="all">All assignees</option></select>
    <select id="st">
      <option value="open" selected>Open</option>
      <option value="done">Done</option>
      <option value="all">All</option>
    </select>
    <button id="ref">Refresh</button>
    <button id="out">Export CSV</button>
    <button id="lo">Logout</button>
  </div>

  <div class="grid">
    <div>
      <div id="list"></div>
    </div>
    <div>
      <canvas id="c1" height="170"></canvas>
      <div style="height:12px"></div>
      <canvas id="c2" height="170"></canvas>
    </div>
  </div>
</div>

<script>
const el={q:document.getElementById("q"),ass:document.getElementById("ass"),st:document.getElementById("st"),
          ref:document.getElementById("ref"),out:document.getElementById("out"),lo:document.getElementById("lo"),
          list:document.getElementById("list")};
let chores=[]; let chart1=null, chart2=null;

const uniq=a=>[...new Set(a.filter(Boolean))].sort();
const esc=s=>(s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

function filtered(){
  const q=(el.q.value||"").toLowerCase().trim();
  const a=el.ass.value;
  const st=el.st.value;
  return chores.filter(c=>{
    const blob=`${c.name||""} ${c.category||""} ${c.assignee||""}`.toLowerCase();
    if(q && !blob.includes(q)) return false;
    if(a!=="all" && String(c.assignee||"")!==a) return false;
    const done=String(c.done).toLowerCase()==="true";
    if(st==="open" && done) return false;
    if(st==="done" && !done) return false;
    return true;
  });
}

function render(){
  const names=uniq(chores.map(c=>String(c.assignee||"")));
  const cur=el.ass.value||"all";
  el.ass.innerHTML='<option value="all">All assignees</option>' + names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");
  el.ass.value = names.includes(cur) ? cur : "all";

  const items=filtered();
  el.list.innerHTML = items.length ? items.map(c=>{
    const done=String(c.done).toLowerCase()==="true";
    const photo=c.photoUrl?String(c.photoUrl):"";
    return `<div class="item">
      <div>
        <div><b>${esc(c.name)}</b> ${done?"‚úÖ":"üü°"}</div>
        <div class="meta">üë§ ${esc(c.assignee||"")} ‚Ä¢ üîÅ ${esc(c.repeat||"none")} ‚Ä¢ üìÖ ${esc(c.due||"")}</div>
      </div>
      <div>${photo?`<a href="${esc(photo)}" target="_blank" rel="noopener">üì∑</a>`:""}</div>
    </div>`;
  }).join("") : '<div style="padding:12px;color:#a9b4e6">No chores</div>';

  // Charts: repeat mix + % complete by assignee
  const rep={};
  chores.forEach(c=>{const r=String(c.repeat||"none"); rep[r]=(rep[r]||0)+1;});
  const labels1=Object.keys(rep), data1=Object.values(rep);
  if(chart1) chart1.destroy();
  chart1=new Chart(document.getElementById("c1"), {
    type:"doughnut",
    data:{labels:labels1,datasets:[{label:"Repeat mix",data:data1}]}
  });

  const ass=uniq(chores.map(c=>String(c.assignee||"")));
  const pct=ass.map(a=>{
    const all=chores.filter(c=>String(c.assignee||"")===a);
    const d=all.filter(c=>String(c.done).toLowerCase()==="true");
    return all.length ? Math.round((d.length/all.length)*100) : 0;
  });
  if(chart2) chart2.destroy();
  chart2=new Chart(document.getElementById("c2"), {
    type:"bar",
    data:{labels:ass,datasets:[{label:"% Complete",data:pct}]},
    options:{scales:{y:{beginAtZero:true,max:100}}}
  });
}

async function refresh(){
  const out = await jsonp("listChores", { assignee:"" });
  chores = (out && out.ok) ? (out.items || []) : [];
  render();
}

el.ref.onclick = refresh;
el.lo.onclick = ()=>{ sessionStorage.removeItem("admin_token"); location.href="index.html"; };
el.out.onclick = ()=>{
  const rows=filtered();
  const headers=["id","name","assignee","due","repeat","done","doneAt","photoUrl"];
  const csv=[headers.join(",")].concat(rows.map(r=>headers.map(h=>`"${String(r[h]??"").replaceAll('"','""')}"`).join(","))).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="chores.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
};

["input","change"].forEach(ev=>{ el.q.addEventListener(ev,render); el.ass.addEventListener(ev,render); el.st.addEventListener(ev,render); });

refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>


