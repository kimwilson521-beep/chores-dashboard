<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maisie Chores</title>

  <!-- PWA (optional but recommended if you added manifest/sw) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1020">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root{
      --bg:#0b1020; --text:#e8ecff; --muted:#a9b4e6; --line:rgba(255,255,255,.10);
      --shadow:0 12px 30px rgba(0,0,0,.35); --radius:18px;
      --ok:#36d399; --warn:#fbbf24; --bad:#fb7185; --hi:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(251,113,133,.18), transparent 60%),
        radial-gradient(1000px 700px at 60% 120%, rgba(54,211,153,.14), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:26px 16px 40px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:24px;letter-spacing:.3px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:10px 12px;border-radius:12px;cursor:pointer;
      transition:.15s ease; color:var(--text);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.07)}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:rgba(96,165,250,.45);background:rgba(96,165,250,.14)}
    .btn.ok{border-color:rgba(54,211,153,.45);background:rgba(54,211,153,.12)}
    .btn.danger{border-color:rgba(251,113,133,.45);background:rgba(251,113,133,.12)}
    .btn.small{padding:8px 10px;border-radius:11px;font-size:12px}

    .card{
      margin-top:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .stats{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
      padding:14px;border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.08);
    }
    @media(max-width:850px){.stats{grid-template-columns:1fr}}
    .stat{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;
    }
    .k{color:var(--muted);font-size:12px}
    .v{font-size:18px;font-weight:750}
    .barOuter{
      width:100%;height:10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);overflow:hidden;
    }
    .barInner{
      height:100%;width:0%;
      background:rgba(54,211,153,.75);
      border-radius:999px;
      transition:width .25s ease;
    }

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:14px;border-bottom:1px solid var(--line);background:rgba(0,0,0,.10);
    }
    input,select{font:inherit;color:var(--text)}
    input[type="text"], select{
      padding:10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);outline:none;
    }
    .list{display:flex;flex-direction:column}
    .item{
      padding:12px 14px;border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      background:rgba(255,255,255,.02);
    }
    .item:last-child{border-bottom:none}
    .meta{display:flex;flex-direction:column;gap:6px;min-width:0}
    .title{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .name{font-weight:800;letter-spacing:.2px}
    .subline{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .tag{
      border:1px solid var(--line);border-radius:999px;padding:4px 8px;background:rgba(255,255,255,.03);
      display:inline-flex;gap:6px;align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--hi);display:inline-block}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .thumb{
      width:42px;height:42px;border-radius:12px;object-fit:cover;border:1px solid var(--line);
      cursor:pointer;display:none;
    }
    .hint{color:rgba(169,180,230,.8);font-size:12px;padding:12px 14px;border-top:1px solid var(--line);background:rgba(0,0,0,.08)}
    .empty{padding:22px;text-align:center;color:var(--muted)}
    .msg{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:var(--muted);font-size:12.5px}
    .msg.bad{border-color:rgba(251,113,133,.35);color:#ffd7df}
    .msg.ok{border-color:rgba(54,211,153,.30);color:#d8fff0}

    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:20px;z-index:11000}
    .lightbox.open{display:flex}
    .lightbox img{max-width:min(1000px,96vw);max-height:86vh;border-radius:16px;border:1px solid rgba(255,255,255,.15);box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .lightbox .close{
      position:absolute;top:14px;right:14px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);color:var(--text);border-radius:12px;padding:10px 12px;cursor:pointer;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Maisie ‚Ä¢ Chores</h1>
      <div class="sub">
        Upload a photo first ‚Üí then you can mark a chore as done.<br>
        This page syncs completions + photos to the Admin dashboard via Supabase.
      </div>
      <div class="msg" id="msg"></div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="refreshBtn">‚Üª Refresh</button>
      <button class="btn danger" id="signOutBtn" title="Only needed if you later add user logins">Sign out</button>
    </div>
  </header>

  <div class="card">
    <div class="stats" id="stats"></div>

    <div class="toolbar">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <input type="text" id="search" placeholder="Search chores‚Ä¶" />
        <select id="filterRepeat">
          <option value="all" selected>All</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="everyX">Every X days</option>
          <option value="none">No repeat</option>
        </select>
        <select id="filterStatus">
          <option value="open" selected>Open</option>
          <option value="done">Done</option>
          <option value="all">All</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <select id="sortBy">
          <option value="dueAsc" selected>Due soon</option>
          <option value="priority">Priority</option>
          <option value="newest">Newest</option>
        </select>
      </div>
    </div>

    <div class="list" id="list"></div>

    <div class="hint">
      Tip: if ‚ÄúDone‚Äù is disabled, attach a photo first. Photos are uploaded to Supabase Storage bucket <b>proof</b>.
    </div>
  </div>
</div>

<!-- lightbox -->
<div class="lightbox" id="lightbox" aria-hidden="true">
  <button class="close" id="lbClose">‚úï Close</button>
  <img id="lbImg" alt="Proof photo" />
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  /************ CONFIG (YOU MUST FILL THESE) ************/
  const SUPABASE_URL = "PASTE_SUPABASE_PROJECT_URL";
  const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_PUBLIC_KEY";

  // Storage bucket name created in Supabase Storage
  const PROOF_BUCKET = "proof";

  // Assignee this page is for:
  const ASSIGNEE = "Maisie";
  /******************************************************/

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  const el = {
    stats: $("stats"),
    list: $("list"),
    search: $("search"),
    filterRepeat: $("filterRepeat"),
    filterStatus: $("filterStatus"),
    sortBy: $("sortBy"),
    refreshBtn: $("refreshBtn"),
    signOutBtn: $("signOutBtn"),
    msg: $("msg"),
    lightbox: $("lightbox"),
    lbImg: $("lbImg"),
    lbClose: $("lbClose"),
  };

  let chores = [];

  function showMsg(text, kind=""){
    el.msg.className = "msg" + (kind ? " " + kind : "");
    el.msg.textContent = text;
    el.msg.style.display = "block";
  }
  function clearMsg(){ el.msg.style.display = "none"; el.msg.textContent = ""; el.msg.className="msg"; }

  function normalize(s){ return (s||"").trim().replace(/\s+/g," "); }
  function pad(n){ return String(n).padStart(2,"0"); }
  function yyyyMmDd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function parseDate(s){
    if(!s) return null;
    const [y,m,d]=s.split("-").map(Number);
    if(!y||!m||!d) return null;
    return new Date(y,m-1,d);
  }
  function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
  function addMonths(date, months){
    const d=new Date(date); const day=d.getDate();
    d.setMonth(d.getMonth()+months);
    if(d.getDate()!==day) d.setDate(0);
    return d;
  }
  function nextDueDate(currentDueStr, repeat, repeatEveryDays){
    const base = parseDate(currentDueStr) || new Date();
    let next = null;
    if(repeat === "daily") next = addDays(base, 1);
    if(repeat === "weekly") next = addDays(base, 7);
    if(repeat === "monthly") next = addMonths(base, 1);
    if(repeat === "everyX"){
      const n = Math.max(2, Math.min(365, Number(repeatEveryDays || 3) || 3));
      next = addDays(base, n);
    }
    return next ? yyyyMmDd(next) : "";
  }
  function priorityScore(p){ return p==="high"?3:p==="medium"?2:1; }

  function repeatText(c){
    if((c.repeat||"none")==="none") return "No repeat";
    if(c.repeat==="daily") return "Daily";
    if(c.repeat==="weekly") return "Weekly";
    if(c.repeat==="monthly") return "Monthly";
    if(c.repeat==="everyX") return `Every ${Number(c.repeat_every_days || 3)} days`;
    return c.repeat;
  }

  function photoUrlFromPath(path){
    if(!path) return "";
    // Bucket is public (fastest). If you made it private later, switch to signed URLs.
    const { data } = supabase.storage.from(PROOF_BUCKET).getPublicUrl(path);
    return data?.publicUrl || "";
  }

  async function loadFromDB(){
    const { data, error } = await supabase
      .from("chores")
      .select("*")
      .eq("assignee", ASSIGNEE)
      .order("created_at", { ascending:false });

    if(error){
      console.error(error);
      showMsg("Could not load chores. Check Supabase config + table name.", "bad");
      return [];
    }
    return data || [];
  }

  async function uploadProof(file, choreId){
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const safeExt = ext.length > 8 ? "jpg" : ext;
    const path = `${ASSIGNEE.toLowerCase()}/${choreId}/${Date.now()}.${safeExt}`;

    const { error } = await supabase.storage
      .from(PROOF_BUCKET)
      .upload(path, file, { upsert: true, cacheControl: "3600" });

    if(error) throw error;
    return path;
  }

  async function completeChoreWithPhoto(chore, file){
    // 1) upload photo
    const path = await uploadProof(file, chore.id);

    // 2) mark done
    const nowIso = new Date().toISOString();
    const { error } = await supabase
      .from("chores")
      .update({
        done: true,
        done_at: nowIso,
        photo_path: path,
        photo_at: nowIso
      })
      .eq("id", chore.id);

    if(error) throw error;

    // 3) if repeating -> create next instance
    const rep = (chore.repeat || "none");
    if(rep !== "none"){
      const nextDue = nextDueDate(chore.due, rep, chore.repeat_every_days);
      const { error: insErr } = await supabase
        .from("chores")
        .insert([{
          name: chore.name,
          assignee: chore.assignee,
          due: nextDue || null,
          priority: chore.priority || "medium",
          repeat: rep,
          repeat_every_days: rep === "everyX" ? (Number(chore.repeat_every_days || 3) || 3) : null,
          category: chore.category || null,
          done: false,
          done_at: null,
          photo_path: null,
          photo_at: null
        }]);

      if(insErr) console.warn("Repeat insert failed:", insErr);
    }
  }

  function computeProgress(){
    const today = new Date();
    const todayYMD = yyyyMmDd(today);

    const open = chores.filter(c => !c.done);
    const done = chores.filter(c => c.done);

    // Daily progress: daily chores due today (or due blank but daily)
    const dailyAll = chores.filter(c => (c.repeat==="daily") && (!c.done) ).length
      + chores.filter(c => (c.repeat==="daily") && c.done && yyyyMmDd(new Date(c.done_at || 0))===todayYMD ).length;

    // More practical daily metric: daily chores currently open due today
    const dailyOpenDueToday = chores.filter(c => !c.done && c.repeat==="daily" && (!c.due || c.due===todayYMD)).length;
    const dailyDoneToday = chores.filter(c => c.done && c.repeat==="daily" && yyyyMmDd(new Date(c.done_at || c.photo_at || 0))===todayYMD).length;
    const dailyTotalToday = dailyOpenDueToday + dailyDoneToday;
    const dailyPct = dailyTotalToday ? Math.round((dailyDoneToday/dailyTotalToday)*100) : 0;

    // Weekly progress: chores marked weekly completed this week (Mon..Sun)
    const day = (today.getDay()+6)%7; // Mon=0
    const mon = addDays(new Date(today.getFullYear(), today.getMonth(), today.getDate()), -day);
    const monMs = mon.getTime();

    const weeklyOpen = chores.filter(c => !c.done && c.repeat==="weekly").length;
    const weeklyDoneThisWeek = chores.filter(c => c.done && c.repeat==="weekly" && (new Date(c.done_at || 0).getTime() >= monMs)).length;
    const weeklyTotal = weeklyOpen + weeklyDoneThisWeek;
    const weeklyPct = weeklyTotal ? Math.round((weeklyDoneThisWeek/weeklyTotal)*100) : 0;

    // Overall
    const overallTotal = chores.length;
    const overallDone = done.length;
    const overallPct = overallTotal ? Math.round((overallDone/overallTotal)*100) : 0;

    return {
      overallPct, overallDone, overallTotal,
      dailyPct, dailyDoneToday, dailyTotalToday,
      weeklyPct, weeklyDoneThisWeek, weeklyTotal
    };
  }

  function statusDot(c){
    if(c.done) return "ok";
    const due = c.due ? parseDate(c.due) : null;
    if(!due) return "";
    const t = new Date(); t.setHours(0,0,0,0);
    due.setHours(0,0,0,0);
    if(due < t) return "bad";
    if(due.getTime() === t.getTime()) return "warn";
    return "";
  }

  function sortItems(items){
    const mode = el.sortBy.value;
    const dueKey = c => (c.due ? (parseDate(c.due)?.getTime() ?? Number.POSITIVE_INFINITY) : Number.POSITIVE_INFINITY);

    const copy = [...items];
    if(mode==="dueAsc") copy.sort((a,b)=> dueKey(a)-dueKey(b));
    else if(mode==="priority") copy.sort((a,b)=> priorityScore(b.priority)-priorityScore(a.priority) || dueKey(a)-dueKey(b));
    else if(mode==="newest") copy.sort((a,b)=> new Date(b.created_at).getTime()-new Date(a.created_at).getTime());
    return copy;
  }

  function filtered(){
    const q = el.search.value.trim().toLowerCase();
    const rep = el.filterRepeat.value;
    const st = el.filterStatus.value;

    return chores.filter(c => {
      if(q){
        const blob = `${c.name} ${c.category||""}`.toLowerCase();
        if(!blob.includes(q)) return false;
      }
      if(rep !== "all" && (c.repeat || "none") !== rep) return false;
      if(st !== "all"){
        if(st === "open" && c.done) return false;
        if(st === "done" && !c.done) return false;
      }
      return true;
    });
  }

  function renderStats(){
    const s = computeProgress();
    el.stats.innerHTML = `
      <div class="stat">
        <div class="k">Overall completion</div>
        <div class="v">${s.overallPct}%</div>
        <div class="barOuter"><div class="barInner" style="width:${s.overallPct}%"></div></div>
        <div class="k">${s.overallDone} done ‚Ä¢ ${s.overallTotal} total</div>
      </div>
      <div class="stat">
        <div class="k">Daily completion (today)</div>
        <div class="v">${s.dailyPct}%</div>
        <div class="barOuter"><div class="barInner" style="width:${s.dailyPct}%"></div></div>
        <div class="k">${s.dailyDoneToday} done ‚Ä¢ ${s.dailyTotalToday} total</div>
      </div>
      <div class="stat">
        <div class="k">Weekly completion (this week)</div>
        <div class="v">${s.weeklyPct}%</div>
        <div class="barOuter"><div class="barInner" style="width:${s.weeklyPct}%"></div></div>
        <div class="k">${s.weeklyDoneThisWeek} done ‚Ä¢ ${s.weeklyTotal} total</div>
      </div>
    `;
  }

  function renderList(){
    const items = sortItems(filtered());
    if(!items.length){
      el.list.innerHTML = `<div class="empty">No chores found.</div>`;
      return;
    }

    el.list.innerHTML = items.map(c => {
      const dot = statusDot(c);
      const dueLabel = c.due ? (parseDate(c.due)?.toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"}) || "‚Äî") : "No due date";
      const pr = (c.priority||"medium");
      const prDot = pr==="high" ? "bad" : pr==="medium" ? "warn" : "ok";
      const rep = repeatText(c);
      const canDone = !c.done; // Done button appears only if open (but still needs photo selected)
      const photoUrl = photoUrlFromPath(c.photo_path);
      const hasPhoto = Boolean(photoUrl);

      return `
        <div class="item" data-id="${c.id}">
          <div class="meta">
            <div class="title">
              <span class="name">${escapeHtml(c.name)}</span>
              ${c.done ? `<span class="tag"><span class="dot ok"></span> Done</span>` : `<span class="tag"><span class="dot ${dot}"></span> Open</span>`}
              <span class="tag"><span class="dot ${prDot}"></span> ${escapeHtml(pr[0].toUpperCase()+pr.slice(1))}</span>
            </div>
            <div class="subline">
              <span class="tag">üìÖ ${escapeHtml(dueLabel)}</span>
              <span class="tag">üîÅ ${escapeHtml(rep)}</span>
              <span class="tag">üè∑Ô∏è ${escapeHtml(c.category || "Uncategorized")}</span>
              ${hasPhoto ? `<span class="tag">üì∑ Uploaded</span>` : `<span class="tag">üì∑ Needed</span>`}
              ${hasPhoto ? `<span class="tag">üïí ${escapeHtml(fmtTime(c.photo_at || c.done_at))}</span>` : ``}
            </div>
          </div>

          <div class="controls">
            <input class="file" type="file" accept="image/*" capture="environment" data-file />
            <button class="btn small" data-action="attach">üìé Attach photo</button>
            ${!c.done ? `<button class="btn small ok" data-action="done" disabled>‚úÖ Done</button>` : ``}
            ${hasPhoto ? `<img class="thumb" data-photo="1" src="${photoUrl}" alt="photo" style="display:block" />` : ``}
          </div>
        </div>
      `;
    }).join("");
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function fmtTime(ts){
    if(!ts) return "";
    const d = new Date(ts);
    return d.toLocaleString();
  }

  // Lightbox
  function openPhoto(src){
    el.lbImg.src = src;
    el.lightbox.classList.add("open");
    el.lightbox.setAttribute("aria-hidden","false");
  }
  function closePhoto(){
    el.lightbox.classList.remove("open");
    el.lightbox.setAttribute("aria-hidden","true");
    el.lbImg.src = "";
  }
  el.lbClose.addEventListener("click", closePhoto);
  el.lightbox.addEventListener("click", (e)=>{ if(e.target === el.lightbox) closePhoto(); });

  // Wire up per-item attach/done
  const pendingFiles = new Map(); // choreId -> File

  document.addEventListener("click", async (e) => {
    const img = e.target.closest("img[data-photo]");
    if(img?.src){ openPhoto(img.src); return; }

    const btn = e.target.closest("button[data-action]");
    if(!btn) return;
    const item = e.target.closest(".item");
    if(!item) return;
    const id = item.getAttribute("data-id");
    const action = btn.getAttribute("data-action");

    const chore = chores.find(x => x.id === id);
    if(!chore) return;

    // attach
    if(action === "attach"){
      const fileInput = item.querySelector("input[data-file]");
      if(!fileInput) return;
      fileInput.click();

      // enable Done when file chosen
      fileInput.onchange = () => {
        const f = fileInput.files && fileInput.files[0];
        const doneBtn = item.querySelector('button[data-action="done"]');
        if(f){
          pendingFiles.set(id, f);
          if(doneBtn) doneBtn.disabled = false; // ‚úÖ require photo before done
          showMsg("Photo selected. Now tap Done.", "ok");
        } else {
          pendingFiles.delete(id);
          if(doneBtn) doneBtn.disabled = true;
        }
      };
      return;
    }

    // done
    if(action === "done"){
      const file = pendingFiles.get(id);
      if(!file){
        showMsg("Attach a photo first.", "bad");
        return;
      }
      btn.disabled = true;
      btn.textContent = "Uploading‚Ä¶";

      try{
        await completeChoreWithPhoto(chore, file);
        pendingFiles.delete(id);
        showMsg("Completed and synced to Admin ‚úÖ", "ok");
        await refresh();
      } catch(err){
        console.error(err);
        showMsg("Upload failed. Check your Supabase Storage bucket + permissions.", "bad");
        btn.disabled = false;
        btn.textContent = "‚úÖ Done";
      }
    }
  });

  // Filters
  ["search","filterRepeat","filterStatus","sortBy"].forEach(id => {
    $(id).addEventListener("input", render);
    $(id).addEventListener("change", render);
  });

  async function refresh(){
    clearMsg();
    chores = await loadFromDB();
    render();
  }

  function render(){
    renderStats();
    renderList();
  }

  // Realtime updates (so if admin adds chores, Maisie sees them)
  supabase
    .channel("chores-maisie-live")
    .on("postgres_changes", { event:"*", schema:"public", table:"chores", filter:`assignee=eq.${ASSIGNEE}` }, async () => {
      chores = await loadFromDB();
      render();
    })
    .subscribe();

  // Buttons
  el.refreshBtn.addEventListener("click", refresh);
  el.signOutBtn.addEventListener("click", async () => {
    // Only needed if you later add user logins.
    await supabase.auth.signOut();
    showMsg("Signed out.", "ok");
  });

  // PWA SW register (optional)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  // Init
  await refresh();
</script>
</body>
</html>
