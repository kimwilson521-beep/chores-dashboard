<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maisie ‚Ä¢ Chores</title>
<style>
body{font-family:system-ui;margin:0;background:#0b1020;color:#e8ecff}
header{padding:16px}
.small{color:#a9b4e6;font-size:13px}
.card{margin:16px;border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(255,255,255,.05);overflow:hidden}
.bar{display:flex;gap:10px;flex-wrap:wrap;padding:12px;border-bottom:1px solid rgba(255,255,255,.12)}
input,select,button{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#e8ecff}
.item{padding:10px 12px;border-top:1px solid rgba(255,255,255,.12);display:flex;justify-content:space-between;gap:10px}
.meta{color:#a9b4e6;font-size:12px;margin-top:4px}
a{color:#e8ecff}
</style>
</head>
<body>
<script>
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbwaa0cARwT_CZKN-6o_QE7HYWXY2NZReMreQK7xu53aPOzMz-696cBaCLppzAc2nLmH/exec";
const ASSIGNEE="Maisie";

function jsonp(action, params={}){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Date.now()+"_"+Math.floor(Math.random()*1e6);
    window[cb]=(data)=>{ try{resolve(data)} finally{ delete window[cb]; s.remove(); } };
    const qs=new URLSearchParams();
    qs.set("action", action);
    Object.entries(params).forEach(([k,v])=>{ if(v!==undefined&&v!==null) qs.set(k,String(v)); });
    qs.set("callback", cb);
    const s=document.createElement("script");
    s.src=WEBAPP_URL+"?"+qs.toString();
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error("JSONP failed")); };
    document.body.appendChild(s);
  });
}

function fileToBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}
</script>

<header>
  <h2 style="margin:0">Maisie ‚Ä¢ Chores</h2>
  <div class="small">Attach photo first, then Done uploads to Drive (fire-and-forget) and refreshes.</div>
</header>

<div class="card">
  <div class="bar">
    <input id="q" placeholder="Search">
    <select id="st">
      <option value="open" selected>Open</option>
      <option value="done">Done</option>
      <option value="all">All</option>
    </select>
    <button id="ref">Refresh</button>
  </div>
  <div id="list"></div>
</div>

<script>
const el={q:document.getElementById("q"),st:document.getElementById("st"),ref:document.getElementById("ref"),list:document.getElementById("list")};
let chores=[]; const pending=new Map();
const esc=s=>(s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

function filtered(){
  const q=(el.q.value||"").toLowerCase().trim();
  const st=el.st.value;
  return chores.filter(c=>{
    const blob=`${c.name||""} ${c.category||""}`.toLowerCase();
    if(q && !blob.includes(q)) return false;
    const done=String(c.done).toLowerCase()==="true";
    if(st==="open" && done) return false;
    if(st==="done" && !done) return false;
    return true;
  });
}

function render(){
  const items=filtered();
  el.list.innerHTML = items.length ? items.map(c=>{
    const done=String(c.done).toLowerCase()==="true";
    const photo=c.photoUrl?String(c.photoUrl):"";
    return `<div class="item" data-id="${esc(c.id)}">
      <div>
        <div><b>${esc(c.name)}</b> ${done?"‚úÖ":"üü°"}</div>
        <div class="meta">üîÅ ${esc(c.repeat||"none")} ‚Ä¢ üìÖ ${esc(c.due||"")}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end">
        <input type="file" accept="image/*" capture="environment" data-file style="display:none">
        ${!done?`<button data-act="attach">Attach</button>`:""}
        ${!done?`<button data-act="done" disabled>Done</button>`:""}
        ${photo?`<a href="${esc(photo)}" target="_blank" rel="noopener">üì∑</a>`:""}
      </div>
    </div>`;
  }).join("") : '<div style="padding:12px;color:#a9b4e6">No chores</div>';
}

async function refresh(){
  const out = await jsonp("listChores", { assignee: ASSIGNEE });
  chores = (out && out.ok) ? (out.items || []) : [];
  render();
}

document.addEventListener("click", async (e)=>{
  const b=e.target.closest("button[data-act]");
  if(!b) return;
  const item=e.target.closest(".item");
  if(!item) return;
  const id=item.getAttribute("data-id");
  const act=b.getAttribute("data-act");

  if(act==="attach"){
    const inp=item.querySelector("input[data-file]");
    const doneBtn=item.querySelector('button[data-act="done"]');
    inp.click();
    inp.onchange=()=>{
      const f=inp.files && inp.files[0];
      if(f){ pending.set(id,f); doneBtn.disabled=false; }
      else { pending.delete(id); doneBtn.disabled=true; }
    };
  }

  if(act==="done"){
    const f=pending.get(id);
    if(!f) return;
    b.disabled=true; b.textContent="Uploading‚Ä¶";
    const base64=await fileToBase64(f);
    const p=new URLSearchParams();
    p.set("action","completeChore");
    p.set("choreId", id);
    p.set("assignee", ASSIGNEE);
    p.set("base64", base64);
    p.set("mimeType", f.type || "image/jpeg");
    p.set("filename", "proof_"+Date.now()+".jpg");

    // Fire-and-forget to bypass CORS read (still reaches Apps Script)
    await fetch(WEBAPP_URL, { method:"POST", mode:"no-cors", body:p });
    pending.delete(id);
    setTimeout(refresh, 1800);
  }
});

["input","change"].forEach(ev=>{ el.q.addEventListener(ev,render); el.st.addEventListener(ev,render); });
el.ref.onclick = refresh;

refresh();
</script>
</body>
</html>
