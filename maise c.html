<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maisie • Chores</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1020">
<style>
  :root{
    --bg:#0b1020; --text:#e8ecff; --muted:#a9b4e6; --line:rgba(255,255,255,.12);
    --shadow:0 18px 50px rgba(0,0,0,.45); --radius:18px;
    --hi:#60a5fa; --ok:#36d399; --bad:#fb7185; --warn:#fbbf24;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
      radial-gradient(900px 500px at 90% 0%, rgba(251,113,133,.18), transparent 60%),
      radial-gradient(1000px 700px at 60% 120%, rgba(54,211,153,.14), transparent 60%),
      var(--bg);
    padding:18px;
  }
  .wrap{max-width:980px;margin:0 auto}
  .card{
    border:1px solid var(--line);
    border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .top{
    padding:16px 18px;
    border-bottom:1px solid var(--line);
    background:rgba(0,0,0,.12);
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }
  h1{margin:0;font-size:18px;letter-spacing:.3px}
  .sub{color:var(--muted);font-size:12.5px;margin-top:6px;line-height:1.35}
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    padding:9px 11px;
    border-radius:12px;
    cursor:pointer;
    font:inherit;
  }
  .btn:hover{background:rgba(255,255,255,.09)}
  .btn.ok{border-color:rgba(54,211,153,.45);background:rgba(54,211,153,.12)}
  .btn.bad{border-color:rgba(251,113,133,.45);background:rgba(251,113,133,.12)}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.18);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.ok{background:var(--ok)}
  .dot.warn{background:var(--warn)}
  .list{padding:14px 18px;display:flex;flex-direction:column;gap:12px}
  .item{border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.14);border-radius:16px;padding:12px}
  .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .name{font-weight:800}
  .meta{color:var(--muted);font-size:12.5px;margin-top:4px;line-height:1.35}
  .photoRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  input[type="file"]{color:var(--muted)}
  .preview{width:120px;height:90px;border-radius:12px;border:1px solid rgba(255,255,255,.12);object-fit:cover;display:none;background:rgba(0,0,0,.2)}
  .hint{color:var(--muted);font-size:12.5px;margin-top:8px}
  .toast{position:fixed;left:18px;right:18px;bottom:18px;display:none;z-index:10000}
  .toast.show{display:block}
  .toastInner{max-width:980px;margin:0 auto;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border-radius:16px;padding:10px 12px;color:var(--text)}
  a{color:var(--hi)}
  code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; font-size:11px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div>
        <h1>Maisie • Chores</h1>
        <div class="sub">Attach a photo, then press Done. Photo is compressed then uploaded to Google Drive.</div>
      </div>
      <div class="actions">
        <span class="pill"><span class="dot warn"></span><span id="countPill">Loading…</span></span>
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn bad" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="list" id="list"></div>
    <div class="hint" style="padding:0 18px 16px">
      Backend: <code id="backendUrl"></code>
    </div>
  </div>
</div>

<!-- Hidden form POST target (more reliable than fetch no-cors) -->
<iframe name="postTarget" style="display:none"></iframe>
<form id="postForm" target="postTarget" method="POST" action="https://script.google.com/macros/s/AKfycbx_H3KG5QXjuvU9SDWWLIq0H70h6bxIF_6guW5Rd7lOUOa9DFOeaHtJhOSDbw9lXa6T/exec" style="display:none">
  <input name="action" value="">
  <input name="choreId" value="">
  <input name="assignee" value="">
  <textarea name="base64"></textarea>
  <input name="mimeType" value="">
  <input name="filename" value="">
</form>

<div class="toast" id="toast"><div class="toastInner" id="toastInner">Saved</div></div>

<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx_H3KG5QXjuvU9SDWWLIq0H70h6bxIF_6guW5Rd7lOUOa9DFOeaHtJhOSDbw9lXa6T/exec";
  const ASSIGNEE = "Maisie";
  document.getElementById('backendUrl').textContent = WEBAPP_URL;

  // user lock
  const who = sessionStorage.getItem('user_name');
  if(!who || who !== ASSIGNEE){
    location.href = "index.html";
  }

  function toast(msg){
    const t = document.getElementById('toast');
    document.getElementById('toastInner').textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2600);
  }

  // JSONP read (no CORS)
  function jsonp(params) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      params.callback = cb;
      const qs = new URLSearchParams(params).toString();
      const s = document.createElement('script');
      s.src = WEBAPP_URL + "?" + qs;

      let done = false;
      window[cb] = (data) => {
        done = true;
        cleanup();
        resolve(data);
      };

      function cleanup(){
        try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      s.onerror = () => {
        if(done) return;
        cleanup();
        reject(new Error("JSONP load failed"));
      };

      document.body.appendChild(s);
      setTimeout(() => {
        if(done) return;
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 12000);
    });
  }

  function niceDate(iso){
    if(!iso) return "";
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
  }
  function doneFlag(c){
    return (String(c.done).toLowerCase()==="true" || c.done===true);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[m]);
  }

  // Compress image to JPEG to avoid Apps Script size limits
  async function compressToJpegDataUrl(file, maxW=1024, maxH=1024, quality=0.65) {
    const img = await new Promise((resolve, reject) => {
      const i = new Image();
      i.onload = () => resolve(i);
      i.onerror = () => reject(new Error("Image load failed"));
      i.src = URL.createObjectURL(file);
    });

    const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
    const w = Math.round(img.width * ratio);
    const h = Math.round(img.height * ratio);

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    const dataUrl = canvas.toDataURL("image/jpeg", quality);
    return dataUrl;
  }

  // Form POST to Apps Script (more reliable than fetch no-cors)
  function postCompleteChore({ choreId, assignee, base64, mimeType, filename }) {
    const form = document.getElementById("postForm");
    form.elements["action"].value = "completeChore";
    form.elements["choreId"].value = String(choreId);
    form.elements["assignee"].value = String(assignee);
    form.elements["base64"].value = String(base64);
    form.elements["mimeType"].value = String(mimeType || "image/jpeg");
    form.elements["filename"].value = String(filename || ("proof_"+Date.now()+".jpg"));
    form.submit();
  }

  let chores = [];
  async function load(){
    const out = await jsonp({ action:"listChores", assignee: ASSIGNEE });
    if(!out.ok) throw new Error(out.error || "Load failed");
    chores = out.items || [];
    render();
  }

  function render(){
    const list = document.getElementById('list');
    list.innerHTML = "";

    const open = chores.filter(c => !doneFlag(c)).length;
    document.getElementById('countPill').textContent = `${open} open • ${chores.length-open} done`;

    chores
      .slice()
      .sort((a,b)=>Number(doneFlag(a))-Number(doneFlag(b)))
      .forEach(c => {
        const el = document.createElement('div');
        el.className = "item";
        const due = c.due ? niceDate(c.due) : "";
        const rep = c.repeat ? (c.repeat==="everyX" ? `Every ${c.repeatEveryDays||""} days` : c.repeat) : "none";
        const isDone = doneFlag(c);

        el.innerHTML = `
          <div class="row">
            <div>
              <div class="name">${escapeHtml(c.name||"")}</div>
              <div class="meta">Due: ${escapeHtml(due)} • Priority: ${escapeHtml(c.priority||"medium")} • Repeat: ${escapeHtml(rep)}</div>
              ${isDone ? `<div class="meta">✅ Done • ${c.photoUrl?`<a href="${c.photoUrl}" target="_blank" rel="noopener">View proof</a>`:""}</div>` : ""}
            </div>
            <div>
              <span class="pill"><span class="dot ${isDone?'ok':'warn'}"></span>${isDone?'Done':'Open'}</span>
            </div>
          </div>

          <div class="photoRow">
            <input type="file" accept="image/*" capture="environment" id="file_${c.id}" ${isDone?'disabled':''}>
            <img class="preview" id="prev_${c.id}" alt="Preview">
            <button class="btn ok" id="done_${c.id}" ${isDone?'disabled':''}>Done</button>
          </div>

          <div class="hint">${isDone ? "Completed." : "Photo required before Done works."}</div>
        `;
        list.appendChild(el);

        const fileInput = el.querySelector(`#file_${CSS.escape(String(c.id))}`);
        const prev = el.querySelector(`#prev_${CSS.escape(String(c.id))}`);
        const doneBtn = el.querySelector(`#done_${CSS.escape(String(c.id))}`);

        doneBtn.disabled = true;

        if(!isDone){
          fileInput.addEventListener('change', ()=>{
            const f = fileInput.files && fileInput.files[0];
            if(!f) {
              prev.style.display = "none";
              doneBtn.disabled = true;
              return;
            }
            prev.src = URL.createObjectURL(f);
            prev.style.display = "block";
            doneBtn.disabled = false;
          });

          doneBtn.addEventListener('click', async ()=>{
            const f = fileInput.files && fileInput.files[0];
            if(!f) return toast("Attach a photo first");

            doneBtn.disabled = true;
            toast("Compressing + uploading…");

            try {
              const dataUrl = await compressToJpegDataUrl(f, 1024, 1024, 0.65);
              // POST
              postCompleteChore({
                choreId: c.id,
                assignee: ASSIGNEE,
                base64: dataUrl,
                mimeType: "image/jpeg",
                filename: "proof_"+Date.now()+".jpg"
              });
              // Give Apps Script time, then reload list
              setTimeout(()=>load().catch(e=>toast("Reload error: "+e.message)), 2500);
              toast("Done ✅ Syncing…");
            } catch(e) {
              toast("Upload failed: " + e.message);
              doneBtn.disabled = false;
            }
          });
        }
      });
  }

  document.getElementById('refreshBtn').addEventListener('click', ()=>load().catch(e=>toast("Load error: "+e.message)));
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    sessionStorage.removeItem('user_name');
    location.href="index.html";
  });

  load().catch(e=>toast("Load error: "+e.message));
  setInterval(()=>load().catch(()=>{}), 60000);
</script>
</body>
</html>
