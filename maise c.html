<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maisie ‚Äî My Chores</title>
  <style>
    :root{
      --bg:#0b1020;
      --text:#e8ecff;
      --muted:#a9b4e6;
      --line:rgba(255,255,255,.10);
      --shadow:0 14px 34px rgba(0,0,0,.35);
      --radius:18px;
      --ok:#36d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --hi:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(251,113,133,.18), transparent 60%),
        radial-gradient(1000px 700px at 60% 120%, rgba(54,211,153,.14), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:900px;margin:auto;padding:24px 16px 40px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:26px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35}
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
    }
    .pill b{color:var(--text)}
    .dot{width:9px;height:9px;border-radius:99px;background:var(--hi);display:inline-block}

    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin-top:14px;
      overflow:hidden;
    }
    .hd{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:800;
    }
    .hd span{font-weight:600;color:var(--muted);font-size:12px}
    .bd{padding:14px}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      background:rgba(255,255,255,.03);
    }
    .meta{flex:1;min-width:0}
    .name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tag{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 8px;
      background: rgba(0,0,0,.18);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot2{width:8px;height:8px;border-radius:99px;background:var(--hi);display:inline-block}
    .dot2.ok{background:var(--ok)}
    .dot2.warn{background:var(--warn)}
    .dot2.bad{background:var(--bad)}

    .actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      flex-shrink:0;
    }

    .btn{
      border:1px solid rgba(96,165,250,.45);
      background:rgba(96,165,250,.14);
      color:var(--text);
      padding:9px 10px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn.done{
      border-color: rgba(54,211,153,.50);
      background: rgba(54,211,153,.14);
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter: grayscale(35%);
    }

    .photo{ margin-top:8px; }
    .photo img{
      max-width:140px;
      max-height:110px;
      object-fit:cover;
      border-radius:12px;
      border:1px solid var(--line);
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:8px;
      line-height:1.35;
    }
    .empty{
      color:var(--muted);
      text-align:center;
      padding:16px;
      border:1px dashed var(--line);
      border-radius:14px;
      background: rgba(0,0,0,.10);
    }
    .foot{margin-top:10px;text-align:center;color:rgba(169,180,230,.75);font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Maisie ‚Äî My Chores</h1>
      <div class="sub">
        Attach a photo first, then tap <b>Done</b>. Photos sync to admin (same device/browser).
      </div>
    </div>
    <span class="pill"><span class="dot"></span> <b id="todayLabel"></b></span>
  </header>

  <section class="card">
    <div class="hd">Today (Daily) <span id="dailyHint"></span></div>
    <div class="bd"><div id="dailyList" class="list"></div></div>
  </section>

  <section class="card">
    <div class="hd">This Week (Weekly) <span id="weeklyHint"></span></div>
    <div class="bd"><div id="weeklyList" class="list"></div></div>
  </section>

  <div class="foot">If something‚Äôs missing, ask the admin to add it.</div>
</div>

<script>
(() => {
  // Shared key (must match admin.html)
  const KEY = "chores_shared_v1";
  const ASSIGNEE = "Maisie";
  const REQUIRE_PHOTO_TO_DONE = true;

  const $ = id => document.getElementById(id);

  const today = new Date();
  $("todayLabel").textContent = today.toLocaleDateString(undefined, { weekday:"short", year:"numeric", month:"short", day:"numeric" });

  function yyyyMmDd(d){
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function parseDate(s){
    if(!s) return null;
    const [y,m,d] = s.split("-").map(Number);
    if(!y || !m || !d) return null;
    return new Date(y, m-1, d);
  }
  function addDays(date, days){
    const d = new Date(date);
    d.setDate(d.getDate()+days);
    return d;
  }
  function addMonths(date, months){
    const d = new Date(date);
    const day = d.getDate();
    d.setMonth(d.getMonth()+months);
    if(d.getDate() !== day) d.setDate(0);
    return d;
  }
  function nextDueDate(currentDueStr, repeat){
    const base = parseDate(currentDueStr) || today;
    let next = null;
    if(repeat === "daily") next = addDays(base, 1);
    if(repeat === "weekly") next = addDays(base, 7);
    if(repeat === "monthly") next = addMonths(base, 1);
    return next ? yyyyMmDd(next) : "";
  }

  function uid(){
    return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch{ return []; }
  }
  function save(items){
    localStorage.setItem(KEY, JSON.stringify(items));
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function dotFor(chore){
    if(chore.done) return "ok";
    const due = parseDate(chore.due);
    if(!due) return "";
    const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const d = new Date(due.getFullYear(), due.getMonth(), due.getDate());
    if(d < t) return "bad";
    if(d.getTime() === t.getTime()) return "warn";
    return "";
  }

  // Ensure starter chores exist (only if missing)
  let chores = load();
  const todayStr = yyyyMmDd(today);

  function seedMaisieIfMissing(){
    const nextWeek = yyyyMmDd(addDays(today, 7));
    const starter = [
      { name:"Cat litter", repeat:"daily", due: todayStr, category:"Pets", priority:"medium", assignee:ASSIGNEE },
      { name:"Washing pots", repeat:"daily", due: todayStr, category:"Kitchen", priority:"medium", assignee:ASSIGNEE },
      { name:"Putting pots away", repeat:"daily", due: todayStr, category:"Kitchen", priority:"low", assignee:ASSIGNEE },
      { name:"Putting away laundry", repeat:"daily", due: todayStr, category:"Laundry", priority:"medium", assignee:ASSIGNEE },
      { name:"Bedroom tidy", repeat:"daily", due: todayStr, category:"Bedroom", priority:"low", assignee:ASSIGNEE },
      { name:"Posts", repeat:"weekly", due: nextWeek, category:"Admin", priority:"high", assignee:ASSIGNEE }
    ];

    const keyOf = (x) => `${(x.name||"").toLowerCase()}|${(x.repeat||"none").toLowerCase()}|${(x.assignee||"").toLowerCase()}`;
    const existing = new Set(chores.map(c => keyOf(c)));

    let changed = false;
    starter.forEach(s => {
      if(existing.has(keyOf(s))) return;
      chores.unshift({
        id: uid(),
        name: s.name,
        assignee: s.assignee,
        due: s.due,
        priority: s.priority,
        repeat: s.repeat,
        category: s.category,
        done: false,
        doneAt: null,
        createdAt: Date.now(),
        photo: null,
        photoAt: null
      });
      changed = true;
    });

    if(changed) save(chores);
  }

  seedMaisieIfMissing();

  function render(){
    chores = load(); // pull latest (admin may have changed)
    const mine = chores.filter(c => (c.assignee || "").trim().toLowerCase() === ASSIGNEE.toLowerCase());

    const daily = mine
      .filter(c => !c.done && c.repeat === "daily" && c.due === todayStr);

    const weekly = mine
      .filter(c => !c.done && (c.repeat === "weekly" || c.repeat === "monthly" || c.repeat === "none"))
      .sort((a,b) => (parseDate(a.due)?.getTime() ?? 9e15) - (parseDate(b.due)?.getTime() ?? 9e15));

    $("dailyHint").textContent = daily.length ? "Finish these today ‚úÖ" : "All done üéâ";
    $("weeklyHint").textContent = weekly.length ? "Work through these ‚úÖ" : "Nothing queued üéâ";

    $("dailyList").innerHTML = daily.length ? daily.map(renderItem).join("") : `<div class="empty">No daily chores left for today.</div>`;
    $("weeklyList").innerHTML = weekly.length ? weekly.map(renderItem).join("") : `<div class="empty">No weekly chores right now.</div>`;
  }

  function renderItem(c){
    const dot = dotFor(c);
    const dueLabel = c.due ? new Date(parseDate(c.due)).toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" }) : "No due date";
    const canDone = REQUIRE_PHOTO_TO_DONE ? !!c.photo : true;

    return `
      <div class="item" data-id="${c.id}">
        <div class="meta">
          <div class="name">${escapeHtml(c.name)}</div>
          <div class="tags">
            <span class="tag"><span class="dot2 ${dot}"></span> Due ${escapeHtml(dueLabel)}</span>
            <span class="tag">üîÅ ${escapeHtml(c.repeat === "none" ? "one-off" : c.repeat)}</span>
            ${c.category ? `<span class="tag">üè∑Ô∏è ${escapeHtml(c.category)}</span>` : ``}
            ${c.photo ? `<span class="tag">üì∑ photo attached</span>` : `<span class="tag">üì∑ photo required</span>`}
          </div>
          ${c.photo ? `<div class="photo"><img src="${c.photo}" alt="Attached photo"></div>` : ``}
          ${!c.photo ? `<div class="hint">Tap <b>üì∑ Photo</b> to attach a picture before you can mark this done.</div>` : ``}
        </div>

        <div class="actions">
          <input type="file" accept="image/*" capture="environment" hidden />
          <button class="btn" data-action="photo">üì∑ Photo</button>
          <button class="btn done" data-action="done" ${canDone ? "" : "disabled"}>‚úÖ Done</button>
        </div>
      </div>
    `;
  }

  function compressImage(file, maxW=1280, quality=0.75){
    // returns Promise<dataURL>
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("Failed to read file"));
      reader.onload = () => {
        const img = new Image();
        img.onerror = () => reject(new Error("Invalid image"));
        img.onload = () => {
          const scale = Math.min(1, maxW / img.width);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);

          const canvas = document.createElement("canvas");
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);

          // JPEG is smaller than PNG for photos
          const out = canvas.toDataURL("image/jpeg", quality);
          resolve(out);
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }

  function attachPhoto(choreId, file){
    const c = chores.find(x => x.id === choreId);
    if(!c) return;

    compressImage(file).then((dataUrl) => {
      c.photo = dataUrl;
      c.photoAt = Date.now();
      save(chores);
      render();
    }).catch(() => {
      alert("Couldn‚Äôt attach that photo. Please try again.");
    });
  }

  function markDone(choreId){
    const c = chores.find(x => x.id === choreId);
    if(!c) return;

    if(REQUIRE_PHOTO_TO_DONE && !c.photo){
      alert("Please attach a photo before marking Done.");
      return;
    }

    c.done = true;
    c.doneAt = Date.now();

    // Create the next occurrence if repeating
    if(c.repeat && c.repeat !== "none"){
      const next = {
        ...c,
        id: uid(),
        due: nextDueDate(c.due, c.repeat),
        done: false,
        doneAt: null,
        createdAt: Date.now(),
        photo: null,
        photoAt: null
      };
      chores.unshift(next);
    }

    save(chores);
    render();
  }

  // Events
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action]");
    if(!btn) return;
    const item = e.target.closest(".item");
    if(!item) return;

    const id = item.getAttribute("data-id");
    const action = btn.getAttribute("data-action");

    if(action === "photo"){
      const input = item.querySelector('input[type="file"]');
      input.value = "";
      input.onchange = () => {
        const file = input.files && input.files[0];
        if(!file) return;
        attachPhoto(id, file);
      };
      input.click();
    }

    if(action === "done"){
      markDone(id);
    }
  });

  // Sync when admin changes localStorage
  window.addEventListener("storage", (ev) => {
    if(ev.key === KEY) render();
  });

  render();
})();
</script>
</body>
</html>
